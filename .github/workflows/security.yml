name: Security Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  security:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run npm security audit
      run: |
        cd backend
        npm audit --audit-level high || echo "Security audit completed"
        
    - name: Basic secret detection
      run: |
        echo "🔍 检查可能的敏感信息..."
        # 检查硬编码的密码
        grep -r "password" backend/ --include="*.js" --include="*.json" | grep -v "bcrypt" | grep -v "test" || echo "✅ 未发现硬编码密码"
        
        # 检查API密钥格式
        grep -r "api_key" . --include="*.js" --include="*.env" || echo "✅ 未发现API密钥"
        
        # 检查JWT密钥
        grep -r "JWT_SECRET" . --include="*.js" --include="*.env" | grep -v "test_jwt" || echo "✅ JWT密钥检查通过"
        
    - name: Check file permissions
      run: |
        echo "📁 检查文件权限..."
        find . -name "*.db" -exec echo "数据库文件: {}" \;
        find . -name ".env" -exec echo "环境文件: {}" \;
