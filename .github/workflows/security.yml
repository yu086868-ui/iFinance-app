name: Security Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  security:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run npm security audit
      run: |
        cd backend
        npm audit --audit-level high || echo "Security audit completed"
        
    - name: Basic secret detection
      run: |
        echo "ğŸ” æ£€æŸ¥å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯..."
        # æ£€æŸ¥ç¡¬ç¼–ç çš„å¯†ç 
        grep -r "password" backend/ --include="*.js" --include="*.json" | grep -v "bcrypt" | grep -v "test" || echo "âœ… æœªå‘ç°ç¡¬ç¼–ç å¯†ç "
        
        # æ£€æŸ¥APIå¯†é’¥æ ¼å¼
        grep -r "api_key" . --include="*.js" --include="*.env" || echo "âœ… æœªå‘ç°APIå¯†é’¥"
        
        # æ£€æŸ¥JWTå¯†é’¥
        grep -r "JWT_SECRET" . --include="*.js" --include="*.env" | grep -v "test_jwt" || echo "âœ… JWTå¯†é’¥æ£€æŸ¥é€šè¿‡"
        
    - name: Check file permissions
      run: |
        echo "ğŸ“ æ£€æŸ¥æ–‡ä»¶æƒé™..."
        find . -name "*.db" -exec echo "æ•°æ®åº“æ–‡ä»¶: {}" \;
        find . -name ".env" -exec echo "ç¯å¢ƒæ–‡ä»¶: {}" \;
